---
title: Estudio del gasto y duración media de los viajes de los turistas extranjeros en distintas comunidades autónomas
author:
 - name: Alejandro León Líndez
   affil: 1
 - name: Adrian Lizzadro Pla
   affil: 2
 - name: Marta Medina Muñiz
   affil: 3
affiliation:
  - num: 1
    address: |
      Máster en Ciencia de Datos
    email: alelin@alumni.uv.es
  - num: 2
    address: |
      Máster en Ciencia de Datos
    email: alizpla@alumni.uv.es
  - num: 3
    address: |
      Máster en Ciencia de Datos
    email: memuiz@alumni.uv.es

# document options
correspondence: |
  email@email.com; Tel.: +XX-000-00-0000.
journal: data
type: article
status: submit
# front matter
simplesummary: |
  Resumen del trabajo
abstract: |
  abstract
# back matter
keywords: |
  keyword 1; keyword 2; keyword 3 (list three to ten pertinent keywords specific 
  to the article, yet reasonably common within the subject discipline.).

# abbreviations:
#   - short: MDPI
#     long: Multidisciplinary Digital Publishing Institute
#   - short: DOAJ
#     long: Directory of open access journals
#   - short: TLA
#     long: Three letter acronym
#   - short: LD 
#     long: linear dichroism
bibliography: mybibfile.bib
appendix: appendix.tex
endnotes: false
output: 
  rticles::mdpi_article:
  extra_dependencies: longtable
  fontsize: 10pt  # Tamaño de fuente ajustado a 10p
---

```{r setup, include=FALSE,width = 60}
# Setup Chunk
library(here)  
library(knitr)

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here()) # Setwd() a la carpeta del 
#proyecto ProyectoAED2024 debido a que por defecto el Rmd trabaja en el working 
#directory de la carpeta ProyectoAED2024_Rmd
#knitr::opts_chunk$set(size = "footnotesize") # use smaller font in the chunks
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE)

```

# Introducción

# Carga de librerías e importación del fichero

Antes de comenzar, eliminamos todas las variables guardadas.

```{r}
rm(list=ls())  # Borrado de todas las variables
```

```{r}
library(readr)  # Librería para importación de datos
library(dplyr) # Librería para arreglo de datos
library(tidyr) # Librería para arreglo de datos
library(ggplot2) # Librería para gráficas
```

Importamos los datos

```{r}
gastos<- read_delim("data/Gasto_turistas_internacionales_segun_comunidad_paisresidencia.csv",  delim = ";", escape_double = FALSE, trim_ws = TRUE)

```

# Preparación de los datos

## Tranformación a tidydata

Observamos que las variables no están correctamente colocadas en columnas.

```{r}
tipos_datos <- unique(gastos$`Gastos y duración media de los viajes`)
tipos_datos # Vemos cuantas variables tenemos que transformar a columnas
```

```{r}
gastos1 <- subset(gastos,gastos$`Gastos y duración media de los viajes`== tipos_datos[1])
colnames(gastos1)[colnames(gastos1)=="Total"]<- "Gasto_total"
gastos1<- subset(gastos1, select = -`Gastos y duración media de los viajes`)
```

```{r}
gastos2 <- subset(gastos,gastos$`Gastos y duración media de los viajes`== tipos_datos[2])
colnames(gastos2)[colnames(gastos2)=="Total"]<- "Gasto_medio_persona"
gastos2<- subset(gastos2, select = -`Gastos y duración media de los viajes`)
```

```{r}
gastos3 <- subset(gastos,gastos$`Gastos y duración media de los viajes`== tipos_datos[3])
colnames(gastos3)[colnames(gastos3)=="Total"]<- "Gasto_medio_diario_persona"
gastos3<- subset(gastos3, select = -`Gastos y duración media de los viajes`)
```

```{r}
gastos4 <- subset(gastos,gastos$`Gastos y duración media de los viajes`== tipos_datos[4])
colnames(gastos4)[colnames(gastos4)=="Total"]<- "Duracion_media"
gastos4<- subset(gastos4, select = -`Gastos y duración media de los viajes`)
```

```{r}

# Compruebo que en todas las columnas salvo la última todos las filas son iguales para poder hacer merge de los dos datasets correctamente
any(gastos1[1:length(nrow(gastos1)-1)] !=gastos2[1:length(nrow(gastos2)-1)])
any(gastos3[1:length(nrow(gastos1)-1)] !=gastos4[1:length(nrow(gastos2)-1)])

```

```{r}
# Uno los dos datasets en un único dataset con el que trabajar

gastos12 <- merge(gastos1,gastos2, by = c(colnames(gastos1[1:length(gastos1)-1])))
gastos34 <- merge(gastos3,gastos4, by = c(colnames(gastos3[1:length(gastos3)-1])))
```

```{r}
# Compruebo que en todas las columnas salvo la última todos las filas son iguales para poder hacer merge de los dos datasets correctamente
any(gastos12[1:length(nrow(gastos12)-2)] !=gastos34[1:length(nrow(gastos34)-2)])


# Uno los dos datasets
datos <- merge(gastos12,gastos34, by = c(colnames(gastos12[1:4])))
```
Eliminamos filas que no vamos a emplear en el estudio (tasa de variación) y columnas redudantes o que contienen información irrelevante,
```{r}
unique(datos$`Tipo de dato`)

# Nos quedamos únicamente con los datos base, quitando las tasas de variación
datos <- subset(datos, datos$`Tipo de dato`== unique(datos$`Tipo de dato`)[1])
# Quito la columna irrelevante
datos <- subset(datos, select = -`Tipo de dato`)
```

```{r}
rm(gastos,gastos1, gastos2, gastos3,gastos34,gastos4,gastos12) # Eliminamos
# algunos variables auxiliares innecesarias a posteriori
```

## Transformación de clases

Todas las variables han sido importadas como tipo carácter.Vamos a transformar las variables Gasto_total, Gasto_medio_persona, Gasto_medio_diario_persona y Duracion_media a numérico, donde previamente transformamos la cadena de carácteres a una que sea interpretable como número para poder aplicar la función as.numeric() correctamente.

```{r}
# lapply(datos,class)
```

```{r}
# Quitar punto de miles
datos[, 4:ncol(datos)] <- lapply(datos[, 4:ncol(datos)], function(x) gsub("\\.", "", x))
# Sustituir coma decimal por punto decimal
datos[, 4:ncol(datos)] <- lapply(datos[, 4:ncol(datos)], function(x) gsub(",", ".", x))
# Transformar a numerico
datos[, 4:ncol(datos)] <- lapply(datos[, 4:ncol(datos)], function(x) as.numeric(x))
# Comprobamos la clase
# lapply(datos,class)
```
Comprobamos si al realizar la transformación se han introducido datos NA.
```{r}
any(is.na(datos))
```
A continuación, transformamos a factor las variables País de residencia y Comunidades Autónomas.
```{r}
# unique(datos$`País de residencia`)
# Transformacion a factor de paises de residencia
datos$`País de residencia` <- as.factor(datos$`País de residencia`)
```

Quitamos algunas filas irrelevantes que contienen datos que consisten en la suma total de los datos de la columna de Comunidades Autónomas para el análisis exploratorio. Sin embargo, los recogeremos en una variable a parte para presentarlo en una visualización más compleja.

```{r}
# Quitar filas de total de columna comunidades autonomas
datos_total_por_residencia <- subset(datos, datos$`Total Nacional y CCAA` == "Total")
datos <- subset(datos,datos$`Total Nacional y CCAA` != "Total")
```

```{r}
# Transformacion a factor de nombres de comunidades
#unique(datos$`Total Nacional y CCAA`)
datos$`Total Nacional y CCAA`<- as.factor(datos$`Total Nacional y CCAA`)
# Cambiamos de nombre los niveles del factor
levels(datos$`Total Nacional y CCAA`) <- c("Andalucía", "Illes Balears","Canarias", "Cataluña","Comunitat Valenciana", "Comunidad de Madrid", "Otras CCAA")


```

## Cambios de nombres de las columnas

Vamos a renombrar las columnas de manera apropiada (sin espacios y con nombres representativos).

```{r}
#colnames(datos)
nombres_columnas <- c("Pais", "CCAA", "Periodo", colnames(datos)[4:7])
colnames(datos)<- nombres_columnas
colnames(datos)
```

## Instance engineering

Vamos a trabajar con valores de las filas para obtener un dataset más apropiado al estudio que deseamos realizar. En primer lugar, queremos deshacernos del nivel "Total" en la variable Pais y transformarla en otro llamado "Otros" en que en el resto de variables contenga la información referente al resto de paises distintos de los cuáles poseemos datos concretos.

```{r}
# Cambiar el nombre de las filas
paises <- levels(datos$Pais)
paises[paises=="Total"] <- "Otros"
levels(datos$Pais) <- paises

```

### Instance engineering de Gasto_total

Para la variable Gasto_total, las filas correspondientes a "Otros" de la variable Pais y las filas correspondientes a "Total" se relacionan de la siguiente manera con $pais\in\{Alemania, Francia,Italia, Países\ Nórdicos, Reino\ Unido, Otros\}$:

$$ \text{Gasto total}_{\text{Pais = total}} = \sum_{pais}{\text{Gasto total}_{pais}}$$
Luego el gasto total de "Otros" es el gasto de "Total" menos el gasto de cada uno de los otros 5 paises disponibles por separado.
```{r}
comunidades <- levels(datos$CCAA)
anos <- unique(datos$Periodo)
for (i in comunidades){
  for (j in anos){
  aux <- datos[datos$CCAA==i & datos$Periodo == j, "Gasto_total"]
datos[datos$CCAA==i & datos$Periodo == j & datos$Pais == "Otros", "Gasto_total"]<- aux[length(aux)] - sum(aux[1:length(aux)-1])  
  }
}

```

### Instance engineering de Gasto_medio_persona, Gasto_medio_diario_persona y Duracion_media

Como en estas variables se trata de una media, no podemos emplear el método usado para Gasto_total. En su lugar consideramos una media ponderada. Si consideramos que el numero de paises totales es 194 tenemos que para $pais \in \{Alemania, Francia,Italia, Países\ Nórdicos, Reino\ Unido\}$

$$
 \overline{Media\ Total} = \frac{5}{194}*\sum_{pais}{Valor\ medio}_{pais} + \frac{194-5}{194}*Valor \ Medio_{otros}
$$

De esta manera, concemos el valor de $\overline{Media\ Total}$ y de ${Valor\ medio}_{pais}$ y podemos calcular el valor de los valores medios para las filas "Otros" de la variable Pais, otorgandoles un mayor peso de manera proporcional al número de países considerados en esta categoría.

```{r}
# Duracion media
for (i in comunidades){
  for (j in anos){
  aux <- datos[datos$CCAA==i & datos$Periodo == j, "Duracion_media"]
datos[datos$CCAA==i & datos$Periodo == j & datos$Pais == "Otros", "Duracion_media"]<- (aux[length(aux)]- (5/194)*sum(aux[1:length(aux)-1]))*194/(194-5)
  }
}

```

```{r}
# Gasto_medio_persona
for (i in comunidades){
  for (j in anos){
  aux <- datos[datos$CCAA==i & datos$Periodo == j, "Gasto_medio_persona"]
datos[datos$CCAA==i & datos$Periodo == j & datos$Pais == "Otros", "Gasto_medio_persona"]<- (aux[length(aux)]- (5/194)*sum(aux[1:length(aux)-1]))*194/(194-5)
  }
}

```

```{r}
# Gasto_medio_diario_persona
for (i in comunidades){
  for (j in anos){
  aux <- datos[datos$CCAA==i & datos$Periodo == j, "Gasto_medio_diario_persona"]
datos[datos$CCAA==i & datos$Periodo == j & datos$Pais == "Otros", "Gasto_medio_diario_persona"]<- (aux[length(aux)]- (5/194)*sum(aux[1:length(aux)-1]))*194/(194-5)
  }
}

rm(i,j,anos,comunidades, paises, aux) # Borrar variables auxiliares
```

Una vez hemos concluido el pre-procesamiento de los datos, vamos a ver un resumen de las variables.

```{r}
summary(datos)
```

# Prueba de ggplot

```{r fig.width=5, fig.height=3}
# Visualización de los datos e interpretación de los posibles patrones

# Visualización previa para tener una idea de ciertas variables de los datos
ggplot(datos, aes(x = Periodo, y = Gasto_total, color = CCAA, group = 1)) +
  geom_point() +
  labs(title = "Evolución del gasto total de turistas por año", x  = "Años", y = "Gasto total en millones de euros")

# Nos centramos en un año en concreto y visualizamos el gasto total por país en ese año
ggplot(datos[datos$Periodo == 2023, ], aes(x = reorder(Pais, -Gasto_total), y = Gasto_total)) +
  geom_bar(stat = "identity", aes(fill = Pais)) +
  coord_flip() +
  labs(title = "Gasto por país de residencia en 2023", x = "Gasto total en millones de euros", y = "País") +  
  theme(legend.position = "none")

# Para analizar únicamente una variable por país en una sola Comunidad Autónoma.
ggplot(datos, aes(x = Pais, y = Duracion_media)) + 
  geom_bar(stat = "identity", fill = "red") +
  facet_grid(.~CCAA["i"],scales = "free") +
  labs(title = "Duración media del viaje por país en Andalucía", x = "País", y = "Duración media del viaje")
```


```{r fig.width=5, fig.height=5}
# Para todas las Comunidades Autónomas por separado
ggplot(datos, aes(x = Pais, y = Duracion_media)) + 
  geom_bar(stat = "identity", fill = "purple") +
  facet_wrap(~ CCAA, scales = "free_y") +  
  labs(title = "Duración media del viaje por país en cada Comunidad Autónoma", 
       x = "País", 
       y = "Duración media del viaje") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

Filtraremos los datos totales por el Periodo y recogeremos solo la variable que nos sirve para representar la magnitud de valores en el mapa de visualización, en este caso el gasto medio por persona

```{r}
gastos_medio_residencia <- datos_total_por_residencia %>% 
  select (`País de residencia`, `Gasto_medio_persona`, Periodo) %>%
  filter (Periodo == '2016' & `País de residencia` != "Total")

gastos_medio_residencia_PN <- gastos_medio_residencia %>% 
  select (`País de residencia`, `Gasto_medio_persona`, Periodo) %>%
  filter(`País de residencia` == "Países Nórdicos")

# Introducimos 4 filas iguales sobre los países nórdicos para separar con el join estos y poder representarlos en el mapa

gastos_medio_residencia <- rbind(gastos_medio_residencia, gastos_medio_residencia_PN,
                                 gastos_medio_residencia_PN, gastos_medio_residencia_PN, gastos_medio_residencia_PN)

# install.packages("sf")
library(sf)
# install.packages("dplyr")
library(dplyr)
# install.packages("ggplot2")
library(ggplot2)
# install.packages("giscoR")
library(giscoR)

año_ref <- 2016

# Datos
countries <- gisco_get_countries(year = año_ref,
                        resolution = 20) %>%
  select(CNTR_ID, NAME_ENGL, geometry) %>%
           st_transform(3035)

paises_english <- c('Germany', 'France', 'Italy', 'Norway', 'Finland', 'Sweden', 'Denmark', 'Iceland', 'United Kingdom')
countries_filtered <- countries %>% filter(NAME_ENGL %in% paises_english)

# Incluir columna de identificación de los países para unir con las coordenadas de los mapas

CNTR_ID <- c('DE', 'FR', 'IT', 'DK', 'UK', 'IS','FI', 'NO', 'SE')
gastos_medio_residencia <- cbind(gastos_medio_residencia, CNTR_ID)


gastos_medio_viz <- gastos_medio_residencia %>% left_join(countries, by=join_by(CNTR_ID == CNTR_ID))



# Mapa base
ggplot(gastos_medio_viz) +
  geom_sf(aes(geometry= geometry, fill=Gasto_medio_persona)) +
  xlim(c(2200000, 7150000)) +
  ylim(c(1380000, 5500000))

# Gráfico
ggplot(gastos_medio_viz) +
  # Primera capa con todos los países
  geom_sf(aes(geometry= geometry), data = gastos_medio_viz, fill = "grey80", color = NA) +
  # Establece límites
  xlim(c(2200000, 7150000)) +
  ylim(c(1380000, 5500000))


```

