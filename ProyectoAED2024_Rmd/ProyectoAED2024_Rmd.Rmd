---
title: Título
author:
 - name: Alejandro León Líndez
   affil: 1
 - name: Adrian Lizzadro Pla
   affil: 2
 - name: Marta Medina Muñiz
   affil: 3
affiliation:
  - num: 1
    address: |
      Máster en Ciencia de Datos
    email: alelin@alumni.uv.es
  - num: 2
    address: |
      Máster en Ciencia de Datos
    email: alizpla@alumni.uv.es
  - num: 3
    address: |
      Máster en Ciencia de Datos
    email: memuiz@alumni.uv.es

# document options
journal: notspecified
type: article
status: submit
# front matter
simplesummary: |
  Resumen.
abstract: |
  Abstract
# back matter
keywords: |
  keyword 1; keyword 2; keyword 3 (list three to ten pertinent keywords specific 
                                   to the article, yet reasonably common within the subject discipline.).


abbreviations:
  - short: MDPI
    long: Multidisciplinary Digital Publishing Institute
  - short: DOAJ
    long: Directory of open access journals
  - short: TLA
    long: Three letter acronym
  - short: LD 
    long: linear dichroism
bibliography: mybibfile.bib
appendix: appendix.tex
endnotes: false
output: 
  rticles::mdpi_article:
  extra_dependencies: longtable
---

```{r setup, include=FALSE}
# Setup Chunk
library(here)
library(knitr)

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here()) # Set working directory a la carpeta del proyecto en lugar de a la sub-cartpeta del Rmd
```

# Introducción

# Carga de librerías e importación del fichero

```{r}
rm(list=ls())  # Borrar todas las variables al principio
```

```{r}
library(readr)
library(ggplot2)
```

```{r}
gastos <- read_delim("data/Gasto_turistas_internacionales_segun_comunidad_paisresidencia.csv",  delim = ";", escape_double = FALSE, trim_ws = TRUE)
```
# Transformacion a tidy data
```{r}
tipos_datos <- unique(gastos$`Gastos y duración media de los viajes`)
tipos_datos
```
```{r}
gastos1 <- subset(gastos,gastos$`Gastos y duración media de los viajes`== tipos_datos[1])
colnames(gastos1)[colnames(gastos1)=="Total"]<- "Gasto_total"
gastos1<- subset(gastos1, select = -`Gastos y duración media de los viajes`)
```


```{r}
gastos2 <- subset(gastos,gastos$`Gastos y duración media de los viajes`== tipos_datos[2])
colnames(gastos2)[colnames(gastos2)=="Total"]<- "Gasto_medio_persona"
gastos2<- subset(gastos2, select = -`Gastos y duración media de los viajes`)
```

```{r}
gastos3 <- subset(gastos,gastos$`Gastos y duración media de los viajes`== tipos_datos[3])
colnames(gastos3)[colnames(gastos3)=="Total"]<- "Gasto_medio_diario_persona"
gastos3<- subset(gastos3, select = -`Gastos y duración media de los viajes`)
```

```{r}
gastos4 <- subset(gastos,gastos$`Gastos y duración media de los viajes`== tipos_datos[4])
colnames(gastos4)[colnames(gastos4)=="Total"]<- "Duracion_media"
gastos4<- subset(gastos4, select = -`Gastos y duración media de los viajes`)
```

```{r}

# Compruebo que en todas las columnas salvo la última todos las filas son iguales para poder hacer merge de los dos datasets correctamente
any(gastos1[1:length(nrow(gastos1)-1)] !=gastos2[1:length(nrow(gastos2)-1)])
any(gastos3[1:length(nrow(gastos1)-1)] !=gastos4[1:length(nrow(gastos2)-1)])

```

```{r}
# Uno los dos datasets en un único dataset con el que trabajar

gastos12 <- merge(gastos1,gastos2, by = c(colnames(gastos1[1:length(gastos1)-1])))
gastos34 <- merge(gastos3,gastos4, by = c(colnames(gastos3[1:length(gastos3)-1])))
```

```{r}
# Compruebo que en todas las columnas salvo la última todos las filas son iguales para poder hacer merge de los dos datasets correctamente
any(gastos12[1:length(nrow(gastos12)-2)] !=gastos34[1:length(nrow(gastos34)-2)])


# Uno los dos datasets
datos <- merge(gastos12,gastos34, by = c(colnames(gastos12[1:4])))
```

```{r}
unique(datos$`Tipo de dato`)

# Nos quedamos únicamente con los datos base, quitando las tasas de variación
datos <- subset(datos, datos$`Tipo de dato`== unique(datos$`Tipo de dato`)[1])
# Quito la columna irrelevante
datos <- subset(datos, select = -`Tipo de dato`)
```

Eliminar variables del entorno auxiliares
```{r}
rm(gastos,gastos1, gastos2, gastos3,gastos34,gastos4,gastos12)
```

## Transformación de clases

```{r}
lapply(datos,class)
```


```{r}
# Quitar punto de miles
datos[, 4:ncol(datos)] <- lapply(datos[, 4:ncol(datos)], function(x) gsub("\\.", "", x))
# Sustituir coma decimal por punto decimal
datos[, 4:ncol(datos)] <- lapply(datos[, 4:ncol(datos)], function(x) gsub(",", ".", x))
# Transformar a numerico
datos[, 4:ncol(datos)] <- lapply(datos[, 4:ncol(datos)], function(x) as.numeric(x))
# Comprobar la clase
lapply(datos,class)
```


```{r}
# Comprobar si hay datos NA
any(is.na(datos))
```


```{r}
unique(datos$`País de residencia`)

# Transformacion a factor de paises de residencia
datos$`País de residencia` <- as.factor(datos$`País de residencia`)
```
Quitar filas irrelevantes (totales que se pueden calcular a partir de los datos) para tener tidy data
```{r}
# Quitar filas de total de columna comunidades autonomas
datos <- subset(datos,datos$`Total Nacional y CCAA` != "Total")
```


```{r}
# Transformacion a factor de nombres de comunidades
unique(datos$`Total Nacional y CCAA`)
datos$`Total Nacional y CCAA`<- as.factor(datos$`Total Nacional y CCAA`)
levels(datos$`Total Nacional y CCAA`) <- c("Andalucía", "Illes Balears","Canarias", "Cataluña","Comunitat Valenciana", "Comunidad de Madrid", "Otras CCAA")


```
## Cambios de nombres de las columnas

```{r}
colnames(datos)
nombres_columnas <- c("Pais", "CCAA", "Periodo", colnames(datos)[4:7])
colnames(datos)<- nombres_columnas
colnames(datos)
```

## Arreglo valores de filas


```{r}
# Cambiar el nombre de las filas
paises <- levels(datos$Pais)
paises[paises=="Total"] <- "Otros"
levels(datos$Pais) <- paises

```


###  Arreglar valores de Gasto_total

Hay que crear filas con valor en pais residencia = resto de paises y asignarla a total - suma del resto de paises por comunidases

```{r}
comunidades <- levels(datos$CCAA)
anos <- unique(datos$Periodo)
for (i in comunidades){
  for (j in anos){
  aux <- datos[datos$CCAA==i & datos$Periodo == j, "Gasto_total"]
datos[datos$CCAA==i & datos$Periodo == j & datos$Pais == "Otros", "Gasto_total"]<- aux[length(aux)] - sum(aux[1:length(aux)-1])  # Gasto del resto de paises es el gasto total - gasto de los otos paises
  }
}

```


### Arreglar valores de las otras 3 variables

Consideramos la media ponderada. Numero de países entre 194 y 206.

 media_total = media_otros x (194-5)/194 + (5/194)x sum(media_paises) Por comunidad autonoma y por año
media_otros = (media_total - (5/194)x sum(media_paises) ) * 194/(194-5)

```{r}
# Arreglar duracion media
for (i in comunidades){
  for (j in anos){
  aux <- datos[datos$CCAA==i & datos$Periodo == j, "Duracion_media"]
datos[datos$CCAA==i & datos$Periodo == j & datos$Pais == "Otros", "Duracion_media"]<- (aux[length(aux)]- (5/194)*sum(aux[1:length(aux)-1]))*194/(194-5)
  }
}

```

```{r}
# Arreglar Gasto_medio_persona
for (i in comunidades){
  for (j in anos){
  aux <- datos[datos$CCAA==i & datos$Periodo == j, "Gasto_medio_persona"]
datos[datos$CCAA==i & datos$Periodo == j & datos$Pais == "Otros", "Gasto_medio_persona"]<- (aux[length(aux)]- (5/194)*sum(aux[1:length(aux)-1]))*194/(194-5)
  }
}

```

```{r}
# Arreglar Gasto_medio_diario_persona
for (i in comunidades){
  for (j in anos){
  aux <- datos[datos$CCAA==i & datos$Periodo == j, "Gasto_medio_diario_persona"]
datos[datos$CCAA==i & datos$Periodo == j & datos$Pais == "Otros", "Gasto_medio_diario_persona"]<- (aux[length(aux)]- (5/194)*sum(aux[1:length(aux)-1]))*194/(194-5)
  }
}

rm(i,j,anos,comunidades, paises, aux)
```


# Prueba de ggplot

```{r}
# Visualización de los datos e interpretación de los posibles patrones

# Visualización previa para tener una idea de ciertas variables de los datos
ggplot(datos, aes(x = Periodo, y = Gasto_total, color = CCAA, group = 1)) +
  geom_point() +
  labs(title = "Evolución del gasto total de turistas por año", x  = "Años", y = "Gasto total en millones de euros")

# Nos centramos en un año en concreto y visualizamos el gasto total por país en ese año
ggplot(datos[datos$Periodo == 2023, ], aes(x = reorder(Pais, -Gasto_total), y = Gasto_total)) +
  geom_bar(stat = "identity", aes(fill = Pais)) +
  coord_flip() +
  labs(title = "Gasto por país de residencia en 2023", x = "Gasto total en millones de euros", y = "País") +  
  theme(legend.position = "none")

# Para analizar únicamente una variable por país en una sola Comunidad Autónoma.
ggplot(datos, aes(x = Pais, y = Duracion_media)) + 
  geom_bar(stat = "identity", fill = "red") +
  facet_grid(.~CCAA["i"],scales = "free") +
  labs(title = "Duración media del viaje por país en Andalucía", x = "País", y = "Duración media del viaje")

# Para todas las Comunidades Autónomas por separado
ggplot(datos, aes(x = Pais, y = Duracion_media)) + 
  geom_bar(stat = "identity", fill = "purple") +
  facet_wrap(~ CCAA, scales = "free_y") +  
  labs(title = "Duración media del viaje por país en cada Comunidad Autónoma", 
       x = "País", 
       y = "Duración media del viaje") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

