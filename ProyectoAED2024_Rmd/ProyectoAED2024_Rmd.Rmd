---
title: Estudio del gasto y duración media de los viajes de los turistas extranjeros en distintas comunidades autónomas
author:
 - name: Alejandro León Líndez
   affil: 1
 - name: Adrian Lizzadro Pla
   affil: 2
 - name: Marta Medina Muñiz
   affil: 3
affiliation:
  - num: 1
    address: |
      Máster en Ciencia de Datos
    email: alelin@alumni.uv.es
  - num: 2
    address: |
      Máster en Ciencia de Datos
    email: alizpla@alumni.uv.es
  - num: 3
    address: |
      Máster en Ciencia de Datos
    email: memuiz@alumni.uv.es

# document options
correspondence: |
  Máster en Ciencia de Datos, Universitá de Valencia.
journal: data
type: article
status: submit
# front matter
simplesummary: |
  Resumen del trabajo
abstract: |
  Estudiar la evolución del gasto total, el gasto medio por persona y el gasto medio diario en el periodo de 2016 a 2023 de turistas con diversos países de residencia en distintas comunidades autónomas. Estudio de la duración media de dichos viajes y su relación con el gasto por persona.
# back matter
keywords: |
  keyword 1; keyword 2; keyword 3 (list three to ten pertinent keywords specific 
  to the article, yet reasonably common within the subject discipline.).

# abbreviations:
#   - short: MDPI
#     long: Multidisciplinary Digital Publishing Institute
#   - short: DOAJ
#     long: Directory of open access journals
#   - short: TLA
#     long: Three letter acronym
#   - short: LD 
#     long: linear dichroism
bibliography: mybibfile.bib
appendix: appendix.tex
endnotes: false
output: 
  rticles::mdpi_article:
  extra_dependencies: longtable
  fontsize: 10pt  # Tamaño de fuente ajustado a 10p
---

```{r setup, include=FALSE,width = 60, warning = FALSE}
# Setup Chunk
library(here)  
library(knitr)

knitr::opts_chunk$set(echo = FALSE)  # Los chunks no aparecen por defecto, pero si se ejecutan y aparecen los resultados.
knitr::opts_knit$set(root.dir = here::here()) # Setwd() a la carpeta del 
#proyecto ProyectoAED2024 debido a que por defecto el Rmd trabaja en el working 
#directory de la carpeta ProyectoAED2024_Rmd
#knitr::opts_chunk$set(size = "footnotesize") # use smaller font in the chunks
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE)
knitr::opts_chunk$set(fig.width = 5, fig.height  = 3.5)
knitr::opts_chunk$set(fig.pos = "H", out.extra = "") # Obligar a que las figuras se muestren en la posición del chunk correspondiente

```

# Introducción

# Carga de librerías e importación del fichero

Antes de comenzar, eliminamos todas las variables guardadas.

```{r}
rm(list=ls())  # Borrado de todas las variables
```

```{r, message = FALSE, echo = TRUE}
library(readr)  # Librería para importación de datos
library(dplyr) # Librería para arreglo de datos
library(tidyr) # Librería para arreglo de datos
library(ggplot2) # Librería para gráficas
library(sf) # Librería para generar el mapa geográfico
library(giscoR) # Librería para generar el mapa geográfico
library(GGally)  # Librería para ggpairs
```

Importamos los datos

```{r, message = FALSE, echo = TRUE}
gastos<- read_delim("data/Gasto_turistas_internacionales_segun_comunidad_paisresidencia.csv",  delim = ";", escape_double = FALSE, trim_ws = TRUE)

```

# Preparación de los datos

## Tranformación a tidydata

Antes de comenzar con el preprocesamiento de los datos, observamos el conjunto de datos importado en la Tabla \ref{tab:unnamed-chunk-4}.

```{r, eval = FALSE, include = FALSE}
knitr::kable(gastos[1:10, ], format = "latex", 
             booktabs = TRUE, 
             caption = "10 primeras filas de los datos importados", 
             align = 'ccc', centering = FALSE,
             table.envir = "table", position = "H")
```

\begin{table}[H]

\caption{\label{tab:unnamed-chunk-4}10 primeras filas de los datos importados}
\begin{adjustwidth}{-\extralength}{0cm}
             \small
\begin{tabular}[t]{cccccc}
\toprule
País de residencia & Total Nacional y CCAA & Tipo de dato & Gastos y duración media de los viajes & Periodo & Total\\
\midrule
Total & Total & Dato base & Gasto total & 2023 & 108.789,41\\
Total & Total & Dato base & Gasto total & 2022 & 87.138,19\\
Total & Total & Dato base & Gasto total & 2021 & 34.903,37\\
Total & Total & Dato base & Gasto total & 2020 & 19.786,78\\
Total & Total & Dato base & Gasto total & 2019 & 91.911,97\\
Total & Total & Dato base & Gasto total & 2018 & 89.750,75\\
Total & Total & Dato base & Gasto total & 2017 & 87.003,93\\
Total & Total & Dato base & Gasto total & 2016 & 77.415,54\\
Total & Total & Dato base & Gasto medio por persona & 2023 & 1.277\\
Total & Total & Dato base & Gasto medio por persona & 2022 & 1.216\\
\bottomrule
\end{tabular}
	\end{adjustwidth}
\end{table}


Transformamos este conjunto de datos a un conjunto tidy, donde cada variable se encuentre en una columna y eliminamos filas que no vamos a emplear en el estudio (tasa de variación) y columnas redudantes o que contienen información irrelevante.  

De esta manera, obtenemos 4 variables a partir de la columna Gastos y duración media de los viajes: el gasto total, el gasto medio por persona, el gasto medio diario por persona y la duración media de los viajes; cuyos valores son los correspondientes a la columna Total.  

Por otro lado, en la columna Tipo de dato contamos con dos valores: Dato base y Tasa de variación anual. Vamos a trabajar únicamente con los datos base, por lo que eliminamos las filas correspondientes a Tasa de variación anual y eliminamos la columna Tipo de dato, que ahora aporta información redundante.  

```{r, include = FALSE}
tipos_datos <- unique(gastos$`Gastos y duración media de los viajes`)
tipos_datos # Vemos cuantas variables tenemos que transformar a columnas
datos <-pivot_wider(gastos,names_from=`Gastos y duración media de los viajes`, values_from=Total) 
```


```{r, include=FALSE}
unique(datos$`Tipo de dato`)

# Nos quedamos únicamente con los datos base, quitando las tasas de variación
datos <- subset(datos, datos$`Tipo de dato`== unique(datos$`Tipo de dato`)[1])
# Quitamos la columna irrelevante
datos <- subset(datos, select = -`Tipo de dato`)
```

## Cambios de nombres de las columnas

Renombramos las columnas de manera apropiada (sin espacios y con nombres representativos de las variables). Los nombres de las variables son los siguientes: Pais, CCAA, Periodo, Gasto_total, Gasto_medio_persona, Gasto_medio_diario_persona y Duracion_media.

```{r, include = FALSE}
nombres_columnas <- c("Pais", "CCAA", "Periodo", "Gasto_total", "Gasto_medio_persona", "Gasto_medio_diario_persona", "Duracion_media")
colnames(datos)<- nombres_columnas
colnames(datos)
```



## Transformación de clases

Todas las variables han sido importadas como tipo carácter. Transformamos las variables Gasto_total, Gasto_medio_persona, Gasto_medio_diario_persona y Duracion_media a numérico, donde previamente transformamos la cadena de carácteres a una que sea interpretable como número para poder aplicar la función as.numeric() correctamente (eliminando el punto de miles y sustituyendo la coma decimal por un punto decimal).

```{r, include = FALSE}
lapply(datos,class)
```

```{r, include=FALSE}
# Quitar punto de miles
datos[, 4:ncol(datos)] <- lapply(datos[, 4:ncol(datos)], function(x) gsub("\\.", "", x))
# Sustituir coma decimal por punto decimal
datos[, 4:ncol(datos)] <- lapply(datos[, 4:ncol(datos)], function(x) gsub(",", ".", x))
# Transformar a numerico
datos[, 4:ncol(datos)] <- lapply(datos[, 4:ncol(datos)], function(x) as.numeric(x))
# Comprobamos la clase
# lapply(datos,class)
```

Comprobamos si al realizar la transformación se han introducido datos NA y a continuación, transformamos a factor las variables Pais y CCAA.

```{r, include = FALSE}
any(is.na(datos))
```

```{r, include=FALSE}
# unique(datos$`País de residencia`)
# Transformacion a factor de paises de residencia
datos$Pais <- as.factor(datos$Pais)
```

Quitamos algunas filas que contienen datos que consisten en la suma total de los datos de la columna CCA (más adelante eliminaremos también los valores correspondientes a Total de la variable Pais). Sin embargo, recogeremos estos valores en datasets datos_totales y datos_total_por_residencia para hacer uso de ellos y obtener información relevante.
Cambiamos los nombres de los niveles del factor CCAA a los siguientes: "Andalucía", "Illes Balears","Canarias", "Cataluña","Comunitat Valenciana", "Comunidad de Madrid", "Otras CCAA".

```{r, include = FALSE}
# Guardamos los datos totales por si resultan útiles en el futuro
datos_totales <- subset(datos,datos$Pais == "Total" | datos$CCAA == "Total")
datos_total_por_residencia <- subset(datos, datos$CCAA == "Total")
```


```{r, include = FALSE}
# Quitar filas de total de columna comunidades autonomas
datos <- subset(datos,datos$CCAA != "Total")
```

```{r, include=FALSE}
# Transformacion a factor de nombres de comunidades
#unique(datos$`Total Nacional y CCAA`)
datos$CCAA<- as.factor(datos$CCAA)
# Cambiamos de nombre los niveles del factor
levels(datos$CCAA) <- c("Andalucía", "Illes Balears","Canarias", "Cataluña","Comunitat Valenciana", "Comunidad de Madrid", "Otras CCAA")


```


## Instance engineering

Vamos a trabajar con valores de las filas para obtener un dataset más apropiado al estudio que deseamos realizar. En primer lugar, queremos deshacernos del nivel "Total" en la variable Pais y transformarla en otro llamado "Otros" en que en el resto de variables contenga la información referente al resto de paises distintos de los cuáles poseemos datos concretos.

```{r, include=FALSE}
# Cambiar el nombre de las filas
paises <- levels(datos$Pais)
paises[paises=="Total"] <- "Otros"
levels(datos$Pais) <- paises

```

### Instance engineering de Gasto_total

Para la variable Gasto_total, las filas correspondientes a "Otros" de la variable Pais y las filas correspondientes a "Total" se relacionan de la siguiente manera con $pais\in$ {Alemania, Francia, Italia, Países Nórdicos, Reino Unido}:

$$ \text{Gasto total}_{\text{Total}} = \sum_{pais}{\text{Gasto total}_{pais}}$$
Luego el gasto total de "Otros" es el gasto de los valores "Total" de Pais menos el gasto de cada uno de los otros 5 paises disponibles por separado.
```{r, include=FALSE}
comunidades <- levels(datos$CCAA)
anos <- unique(datos$Periodo)
for (i in comunidades){
  for (j in anos){
  aux <- datos[datos$CCAA==i & datos$Periodo == j, "Gasto_total"]
datos[datos$CCAA==i & datos$Periodo == j & datos$Pais == "Otros", "Gasto_total"]<- aux[length(aux),] - sum(aux[1:length(aux)-1,])  
  }
}

```



### Instance engineering de Gasto_medio_persona, Gasto_medio_diario_persona y Duracion_media

Como en estas variables se trata de una media, no podemos emplear el método usado para Gasto_total. En su lugar consideramos una media ponderada. Si consideramos que el número de paises totales es 194 tenemos que para $pais \in$ 
{Alemania, Francia, Italia, Países Nórdicos, Reino Unido}:

$$
 \overline{Media\ Total} = \frac{5}{194}*\sum_{pais}{Valor\ medio}_{pais} + \frac{194-5}{194}*Valor \ Medio_{otros}
$$

De esta manera, concemos el valor de $\overline{Media\ Total}$ y de ${Valor\ medio}_{pais}$ y podemos calcular el valor de los valores medios para las filas "Otros" de la variable Pais, otorgándoles un mayor peso de manera proporcional al número de países considerados en esta categoría.

```{r, include=FALSE}
# Duracion media
for (i in comunidades){
  for (j in anos){
  aux <- datos[datos$CCAA==i & datos$Periodo == j, "Duracion_media"]
datos[datos$CCAA==i & datos$Periodo == j & datos$Pais == "Otros", "Duracion_media"]<- (aux[length(aux),]- (5/194)*sum(aux[1:length(aux)-1,]))*194/(194-5)
  }
}

```

```{r, include=FALSE}
# Gasto_medio_persona
for (i in comunidades){
  for (j in anos){
  aux <- datos[datos$CCAA==i & datos$Periodo == j, "Gasto_medio_persona"]
datos[datos$CCAA==i & datos$Periodo == j & datos$Pais == "Otros", "Gasto_medio_persona"]<- (aux[length(aux),]- (5/194)*sum(aux[1:length(aux)-1,]))*194/(194-5)
  }
}

```

```{r, include=FALSE}
# Gasto_medio_diario_persona
for (i in comunidades){
  for (j in anos){
  aux <- datos[datos$CCAA==i & datos$Periodo == j, "Gasto_medio_diario_persona"]
datos[datos$CCAA==i & datos$Periodo == j & datos$Pais == "Otros", "Gasto_medio_diario_persona"]<- (aux[length(aux),]- (5/194)*sum(aux[1:length(aux)-1,]))*194/(194-5)
  }
}

rm(i,j,anos,comunidades, paises, aux) # Borrar variables auxiliares
```


# Resumen de los datos

Una vez hemos concluido el pre-procesamiento de los datos, observamos el resultado en la Tabla \ref{tab:unnamed-chunk-27}.


```{r, eval=FALSE, include = FALSE}
knitr::kable(datos[1:10, ], format = "latex", 
             booktabs = TRUE, 
             caption = "This is a table caption. Tables should be placed in the 
             main text near to the first time they are~cited.", 
             align = 'ccc', centering = FALSE,
             table.envir = "table", position = "H")
```



\begin{table}[H]

\caption{\label{tab:unnamed-chunk-27} 10 primeras filas del conjunto de datos procesados}
             \begin{adjustwidth}{-\extralength}{0cm}
             \small
\begin{tabular}[t]{lccccccc}
\toprule
  & Pais & CCAA & Periodo & Gasto\_total & Gasto\_medio\_persona & Gasto\_medio\_diario\_persona & Duracion\_media\\
\midrule
1 & Alemania & Andalucía & 2016 & 1121.33 & 1132 & 102 & 11.14\\
2 & Alemania & Andalucía & 2017 & 1258.89 & 1123 & 105 & 10.70\\
3 & Alemania & Andalucía & 2018 & 1256.69 & 1165 & 114 & 10.18\\
4 & Alemania & Andalucía & 2019 & 1168.38 & 1048 & 117 & 8.96\\
5 & Alemania & Andalucía & 2020 & 255.96 & 1056 & 102 & 10.34\\
6 & Alemania & Andalucía & 2021 & 464.01 & 1040 & 100 & 10.39\\
7 & Alemania & Andalucía & 2022 & 1045.65 & 1211 & 113 & 10.69\\
8 & Alemania & Andalucía & 2023 & 1314.95 & 1267 & 130 & 9.71\\
17 & Alemania & Illes Balears & 2016 & 4436.99 & 961 & 129 & 7.44\\
18 & Alemania & Illes Balears & 2017 & 4890.66 & 1013 & 133 & 7.63\\
\bottomrule
\end{tabular}
	\end{adjustwidth}
\end{table} 

Vamos un resumen de los datos y de las variables disponibles. En la Tabla \ref{tab:codebook} se ha realizado un pequeño codebook con las variables del dataset.

\begin{table}[H]
 \caption{\label{tab:codebook} Descripción de las variables}
             \begin{adjustwidth}{-\extralength}{0cm}
             \small
             \centering
\begin{tabular}{@{}ccc@{}}
\toprule
Nombre variable & Unidad & Valores \\ \midrule
Pais & - & \begin{tabular}[c]{@{}c@{}}Alemania, Italia, Países Nórdicos, Francia, \\ Reino Unido, Otros\end{tabular} \\
CCAA & - & \begin{tabular}[c]{@{}c@{}}Andalucía, Illes Balears, Canarias, Cataluña, Comunitat Valenciana, \\ Comunidad de Madrid, Otras CCAA\end{tabular} \\
Periodo & Año & 2016-2023 \\
Gasto\_total & Millones de euros & Numérico \\
Gasto\_medio\_persona & Euros & Numérico \\
Gasto\_medio\_diario\_persona & Euros & Numérico \\
Duración\_media & Días & Numérico \\ \bottomrule
\end{tabular}

\end{adjustwidth}
\end{table}

Finalmente, antes de comenzar a visualizar datos y detectar patrones vemos un pequeño resumen de los datos:
```{r}
datos_resumen <- datos[4:7]
names(datos_resumen) <- c("Gasto total", "Gasto medio por persona", "Gasto medio diario por persona", "Duración media")

kable(summary(datos_resumen), format = "markdown")
```


# Prueba de ggplot

```{r}
# Visualización de los datos e interpretación de los posibles patrones

# Visualización previa para tener una idea de ciertas variables de los datos
ggplot(datos, aes(x = Periodo, y = Gasto_total, color = CCAA, group = 1)) +
  geom_point() +
  labs(title = "Evolución del gasto total de turistas por año", x  = "Años", y = "Gasto total en millones de euros")
```


```{r}
# Nos centramos en un año en concreto y visualizamos el gasto total por país en ese año
ggplot(datos[datos$Periodo == 2023, ], aes(x = reorder(Pais, -Gasto_total), y = Gasto_total)) +
  geom_bar(stat = "identity", aes(fill = Pais)) +
  coord_flip() +
  labs(title = "Gasto por país de residencia en 2023", x = "Gasto total en millones de euros", y = "País") +  
  theme(legend.position = "none")
```


```{r}
# Para analizar únicamente una variable por país en una sola Comunidad Autónoma.
ggplot(datos, aes(x = Pais, y = Duracion_media)) + 
  geom_bar(stat = "identity", fill = "red") +
  facet_grid(.~CCAA["i"],scales = "free") +
  labs(title = "Duración media del viaje por país en Andalucía", x = "País", y = "Duración media del viaje")
```


```{r fig.width=5, fig.height=5}
# Para todas las Comunidades Autónomas por separado
ggplot(datos, aes(x = Pais, y = Duracion_media)) + 
  geom_bar(stat = "identity", fill = "purple") +
  facet_wrap(~ CCAA, scales = "free_y") +  
  labs(title = "Duración media del viaje por país en cada Comunidad Autónoma", 
       x = "País", 
       y = "Duración media del viaje") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

# Probamos a analizar el efecto del COVID en el gasto de los turistas, así como los países que más reducieron su gasto debido a la pandemia.

```{r}
library(tidyr)

covid <- datos[datos$Periodo == 2020, ]
no_covid <- datos[datos$Periodo != 2020, ]
media_sin_covid <- mean(no_covid$Gasto_total[])
media_covid <- mean(covid$Gasto_total)
cat("La media del gasto total durante el COVID es de", media_covid,"millones de euros\n")
cat("Mientras que sin COVID es de", media_sin_covid,"millones de euros\n")




datos %>% ggplot(aes(x = factor(Periodo), y = Gasto_total, fill = (Periodo == 2020))) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("grey", "red")) +
  labs(x = "Año", y = "Gasto Total de Turistas", title = "Comparación del Gasto Total de Turistas por Año") +
  theme_minimal() +
  theme(legend.position = "none")
```


```{r}
covid_sin_otros <- covid[covid$Pais != "Otros", ] # Elimino los datos correspondientes a otros países ya que son una suma y no se representa correctamente la tendencia.
covid_sin_otros %>% ggplot(aes(x = Pais, y = Gasto_total, fill = Pais)) + geom_bar(stat = "identity") + labs(title = "Gasto total de los distintos países durante el COVID") # Reino Unido gastó más en COVID que el resto de países, Italia el que menos.
```


```{r fig.width= 5}
#¿En qué comunidad autónoma se viajó más durante el COVID?
covid_sin_otros %>% ggplot(aes(x = CCAA, y = Gasto_total, fill = CCAA)) + geom_bar(stat = "identity")  + labs(title = "Gasto total en las distintas comunidades autónomas durante el COVID")

# En Canarias el gasto de turistas fue mayor que en el resto de Comunidades Autónomas durante el COVID, ¿menor regulación?
```

Filtraremos los datos totales por el Periodo y recogeremos solo la variable que nos sirve para representar la magnitud de valores en el mapa de visualización, en este caso el gasto medio por persona

```{r}
gastos_medio_residencia <- datos_total_por_residencia %>% 
  select (Pais, Gasto_medio_persona, Periodo) %>%
  filter (Periodo == '2016' & Pais != "Total")

gastos_medio_residencia_PN <- gastos_medio_residencia %>% 
  select (Pais, Gasto_medio_persona, Periodo) %>%
  filter(Pais == "Países Nórdicos")

# Introducimos 4 filas iguales sobre los países nórdicos para separar con el join estos y poder representarlos en el mapa

gastos_medio_residencia <- rbind(gastos_medio_residencia, gastos_medio_residencia_PN,
                                 gastos_medio_residencia_PN, gastos_medio_residencia_PN, gastos_medio_residencia_PN)

año_ref <- 2016

# Datos
countries <- gisco_get_countries(year = año_ref,
                        resolution = 20) %>%
  select(CNTR_ID, NAME_ENGL, geometry) %>%
           st_transform(3035)

paises_english <- c('United Kingdom', 'Denmark', 'Germany', 'France', 'Italy', 'Sweden', 'Norway', 'Iceland', 'Finland')
countries_filtered <- countries %>% filter(NAME_ENGL %in% paises_english)

# Incluir columna de identificación de los países para unir con las coordenadas de los mapas

CNTR_ID <- c('UK','DK', 'DE', 'FR', 'IT', 'SE', 'NO','IS', 'FI')
gastos_medio_residencia <- cbind(gastos_medio_residencia, CNTR_ID)


gastos_medio_viz <- gastos_medio_residencia %>% left_join(countries, by=join_by(CNTR_ID == CNTR_ID))
```


```{r, fig.pos='H'}
# Mapa base 
ggplot(gastos_medio_viz) +
  geom_sf(aes(geometry= geometry, fill=Gasto_medio_persona)) +
  xlim(c(2200000, 7150000)) +
  ylim(c(1380000, 5500000))


# Marta: Te comenté esta parte porque me estaba dando problemas al hacer knit no se por qué

# Gráfico
# ggplot(gastos_medio_viz) +
#   # Primera capa con todos los países
#   geom_sf(aes(geometry= geometry), data = gastos_medio_viz, fill = "grey80", color = NA) +
#   # Establece límites
#   xlim(c(2200000, 7150000)) +
#   ylim(c(1380000, 5500000))

```

# Búsqueda de relaciones entre variables cuantitativas

Realizamos una visualización previa para detectar relaciones entre variables cuantitativas. En el gráfico \ref{fig:correlaciones}, se observan 3 relaciones que podemos estudiar un poco más a fondo: el gasto medio por persona frente al gasto medio diario, el gasto medio por persona frente a la duración media y el gasto medio diario frente a la duración media.
```{r, message = FALSE, fig.cap="Gráficos de dispersión y correlaciones entre variables cuantitativas.\\label{fig:correlaciones}", fig.pos='H'}
ggpairs(datos[4:7])+theme(axis.text = element_blank()) # Quita los números de los ejes
# Gráficos de dispersión y correlaciones entre variables cuantitativas
``` 

##  Gasto medio por persona y duración media


```{r, fig.cap="Gráficos de dispersión y correlaciones entre gasto medio por persona y la duración media de los viajes .\\label{fig:gastomediovsduracionmedia}", fig.pos='H'}
# Cálculo de las correlaciones
correlaciones <- datos %>%
  group_by(Pais) %>%
  summarise(correlacion = cor(Gasto_medio_persona, Duracion_media))


ggplot(data = datos, aes(x=Gasto_medio_persona, y =Duracion_media, color = CCAA)) + geom_point() + facet_wrap(~ Pais, labeller = label_wrap_gen(width = 15)) +
  labs(title = "Gasto medio por persona y duración media\n por país de residencia",
       x = "Gasto medio por persona (euros)",
       y = "Duración media de los viajes (días)") + theme_minimal() +
  geom_text(
    data = correlaciones,
    aes(label = paste("Cor.:", round(correlacion, 2))),
    x = Inf, y = Inf, hjust = 1.5, vjust = 1.1, size = 3, color = "black"
  )+
  theme(axis.text.x = element_blank())   # Quita los números del eje X
```


Se observa una relación aproximadamente lineal para la mayoría de países, donde se distinguen claramente la tendencia de duración de los viajes en las distintas comunidades autónomas, casi siempre mayor en la Comunitat Valenciana (salvo en Italia, probablemente por cercanía), excepto en la categoría de otros países. Debido a que esta categoría engloba a el resto de países del mundo, es más díficil encontrar relaciones.

## Gasto medio por persona frente al gasto medio diario por persona


Esta parece a priori la relación más obvia entre variables.
```{r,  fig.cap="Gráficos de dispersión y correlaciones entre gasto medio por persona y gasto medio diario por persona .\\label{fig:gastomediovsgastomediodiario}", fig.pos='H', fig.height=4}

# Cálculo de las correlaciones
correlaciones <- datos %>%
  group_by(CCAA) %>%
  summarise(correlacion = cor(Gasto_medio_persona, Gasto_medio_diario_persona))

ggplot(data = datos, aes(x=Gasto_medio_persona, y =Gasto_medio_diario_persona, color = Pais)) + geom_point(size = 1) + facet_wrap(~ CCAA, labeller = label_wrap_gen(width = 15)) +
  labs(title = "Relación entre gasto medio por persona y gasto\nmedio diario por comunidad autónoma",
       x = "Gasto medio por persona (euros)",
       y = "Gasto medio diario por persona (días)") + theme_minimal() +
   geom_text(
    data = correlaciones,
    aes(label = paste("Cor.:", round(correlacion, 2))),
    x = Inf, y = Inf, hjust = 1.6, vjust = 1, size = 3, color = "black"
  ) +
   theme(axis.text.x = element_blank())   # Quita los números del eje X
```

En la Comunitat Valenciana es donde hay una peor correlación, esto puede estar relacionado con que es también el destino de mayor duración de los viajes, lo que puede provocar un menor gasto medio diario.


```{r, fig.cap="Gráfico de dispersión entre gasto medio por persona y gasto medio diario .\\label{fig:gastomediovsgastomediodiarioconduracion}", fig.pos='H'}

ggplot(data = datos, aes(x=Gasto_medio_persona, y =Gasto_medio_diario_persona, color = Duracion_media)) + geom_point(size = 2)  + scale_color_gradient(low = "lightgreen", high = "darkgreen") +  # Gradiente en tonos de verde
  labs(title = "Relación entre gasto medio por persona y gasto\nmedio diario por comunidad autónoma",
       x = "Gasto medio por persona (euros)",
       y = "Gasto medio diario por persona (días)",
       color = "Duración media (días)") + theme_minimal() 
```

En el gráfico \ref{fig:gastomediovsgastomediodiarioconduracion} se puede ver que generalmente a mayor gasto medio por persona también se produce un mayor gasto medio diario. Sin embargo, observamos que aparentemente un aumento de la duración de los viajes provoca una disminución del gasto medio diario. Vamos a visualizar esto más claramente a continuación.

## Gasto medio diario y duracion media 


```{r,fig.cap="Gráfico de dispersión entre gasto medio diario por persona y duración media de los viajes .\\label{fig:gastomediodiariovsduracionmedia}", fig.pos='H'}
# Cálculo de las correlaciones
correlaciones <- datos %>%
  group_by(Pais) %>%
  summarise(correlacion = cor(Gasto_medio_diario_persona, Duracion_media))


ggplot(data = datos, aes(x=Gasto_medio_diario_persona, y =Duracion_media, color = CCAA)) + geom_point(size = 1) + facet_wrap(~ Pais, labeller = label_wrap_gen(width = 15)) +
  labs(title = "Relación entre gasto medio por persona y duración\nmedia por país de residencia",
       x = "Gasto medio por persona (euros)",
       y = "Duración media de los viajes (días)") + theme_minimal() +
  geom_text(
    data = correlaciones,
    aes(label = paste("Cor.:", round(correlacion, 2))),
    x = Inf, y = Inf, hjust =1, vjust = 1, size = 3, color = "black"
  )
```

Ahora podemos observar en el Gráfico \ref{fig:gastomediodiariovsduracionmedia} de manera clara que a mayor duración de los viajes se produce un menor gasto medio por persona.