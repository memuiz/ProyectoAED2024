---
title: Estudio del gasto y duración media de los viajes de los turistas extranjeros en distintas comunidades autónomas
author:
 - name: Alejandro León Líndez
   affil: 1
 - name: Adrian Lizzadro Pla
   affil: 2
 - name: Marta Medina Muñiz
   affil: 3
affiliation:
  - num: 1
    address: |
      Máster en Ciencia de Datos
    email: alelin@alumni.uv.es
  - num: 2
    address: |
      Máster en Ciencia de Datos
    email: alizpla@alumni.uv.es
  - num: 3
    address: |
      Máster en Ciencia de Datos
    email: memuiz@alumni.uv.es

# document options
correspondence: |
  Máster en Ciencia de Datos, Universitá de Valencia.
journal: data
type: article
status: submit
# front matter
simplesummary: |
  Resumen del trabajo
abstract: |
  Estudiar la evolución del gasto total, el gasto medio por persona y el gasto medio diario en el periodo de 2016 a 2023 de turistas con diversos países de residencia en distintas comunidades autónomas. Estudio de la duración media de dichos viajes y su relación con el gasto por persona.
# back matter
keywords: |
  keyword 1; keyword 2; keyword 3 (list three to ten pertinent keywords specific 
  to the article, yet reasonably common within the subject discipline.).

# abbreviations:
#   - short: MDPI
#     long: Multidisciplinary Digital Publishing Institute
#   - short: DOAJ
#     long: Directory of open access journals
#   - short: TLA
#     long: Three letter acronym
#   - short: LD 
#     long: linear dichroism
bibliography: mybibfile.bib
appendix: appendix.tex
endnotes: false
output: 
  rticles::mdpi_article:
  extra_dependencies: longtable
  fontsize: 10pt  # Tamaño de fuente ajustado a 10p
always_allow_html: true
---

```{r setup, include=FALSE,width = 60, warning = FALSE}
# Setup Chunk
library(here)  
library(knitr)

knitr::opts_chunk$set(echo = FALSE)  # Los chunks no aparecen por defecto, pero si se ejecutan y aparecen los resultados.
knitr::opts_knit$set(root.dir = here::here()) # Setwd() a la carpeta del 
#proyecto ProyectoAED2024 debido a que por defecto el Rmd trabaja en el working 
#directory de la carpeta ProyectoAED2024_Rmd
#knitr::opts_chunk$set(size = "footnotesize") # use smaller font in the chunks
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE)
knitr::opts_chunk$set(fig.width = 5, fig.height  = 3.5)
knitr::opts_chunk$set(fig.pos = "H", out.extra = "") # Obligar a que las figuras se muestren en la posición del chunk correspondiente

```

# Introducción

# Carga de librerías e importación del fichero

Antes de comenzar, eliminamos todas las variables guardadas y cargamos todas las librerías a emplear.

```{r}
rm(list=ls())  # Borrado de todas las variables
```

```{r, message = FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(readr, dplyr, tidyr,ggplot2,sf, giscoR,ggiraph,GGally,ggridges)
# library(readr)  # Librería para importación de datos
# library(dplyr) # Librería para arreglo de datos
# library(tidyr) # Librería para arreglo de datos
# library(ggplot2) # Librería para gráficas
# library(sf) # Librería para generar el mapa geográfico
# library(giscoR) # Librería para generar el mapa geográfico
# library(ggiraph) # Librería para añadir interactividad al mapa geográfico
# library(GGally)  # Librería para ggpairs

```

Importamos los datos "Gasto_turistas_internacionales_segun_comunidad_paisresidencia.csv" obtenidos de la base de datos del Instituto Nacional de Estadística (INE).

```{r, message = FALSE}
gastos<- read_delim("data/Gasto_turistas_internacionales_segun_comunidad_paisresidencia.csv",  delim = ";", escape_double = FALSE, trim_ws = TRUE)

```

# Preparación de los datos

## Tranformación a tidydata

Antes de comenzar con el preprocesamiento de los datos, observamos el conjunto de datos importado en la Tabla \ref{tab:unnamed-chunk-4}.

```{r, eval = FALSE, include = FALSE}
knitr::kable(gastos[1:10, ], format = "latex", 
             booktabs = TRUE, 
             caption = "10 primeras filas de los datos importados", 
             align = 'ccc', centering = FALSE,
             table.envir = "table", position = "H")
```

\begin{table}[H]

\caption{\label{tab:unnamed-chunk-4}10 primeras filas de los datos importados}
\begin{adjustwidth}{-\extralength}{0cm}
             \small
\begin{tabular}[t]{cccccc}
\toprule
País de residencia & Total Nacional y CCAA & Tipo de dato & Gastos y duración media de los viajes & Periodo & Total\\
\midrule
Total & Total & Dato base & Gasto total & 2023 & 108.789,41\\
Total & Total & Dato base & Gasto total & 2022 & 87.138,19\\
Total & Total & Dato base & Gasto total & 2021 & 34.903,37\\
Total & Total & Dato base & Gasto total & 2020 & 19.786,78\\
Total & Total & Dato base & Gasto total & 2019 & 91.911,97\\
Total & Total & Dato base & Gasto total & 2018 & 89.750,75\\
Total & Total & Dato base & Gasto total & 2017 & 87.003,93\\
Total & Total & Dato base & Gasto total & 2016 & 77.415,54\\
Total & Total & Dato base & Gasto medio por persona & 2023 & 1.277\\
Total & Total & Dato base & Gasto medio por persona & 2022 & 1.216\\
\bottomrule
\end{tabular}
	\end{adjustwidth}
\end{table}


Transformamos este conjunto de datos a un conjunto tidy, donde cada variable se encuentre en una columna y eliminamos filas que no vamos a emplear en el estudio (tasa de variación) y columnas redudantes o que contienen información irrelevante.  

De esta manera, obtenemos 4 variables a partir de la columna Gastos y duración media de los viajes: el gasto total, el gasto medio por persona, el gasto medio diario por persona y la duración media de los viajes; cuyos valores son los correspondientes a la columna Total.  

Por otro lado, en la columna Tipo de dato contamos con dos valores: Dato base y Tasa de variación anual. Vamos a trabajar únicamente con los datos base, por lo que eliminamos las filas correspondientes a Tasa de variación anual y eliminamos la columna Tipo de dato, que ahora aporta información redundante.  

```{r, include = FALSE}
tipos_datos <- unique(gastos$`Gastos y duración media de los viajes`)
tipos_datos # Vemos cuantas variables tenemos que transformar a columnas
datos <-pivot_wider(gastos,names_from=`Gastos y duración media de los viajes`, values_from=Total) 
```


```{r, include=FALSE}
unique(datos$`Tipo de dato`)

# Nos quedamos únicamente con los datos base, quitando las tasas de variación
datos <- subset(datos, datos$`Tipo de dato`== unique(datos$`Tipo de dato`)[1])
# Quitamos la columna irrelevante
datos <- subset(datos, select = -`Tipo de dato`)
```

Renombramos las columnas de manera apropiada (sin espacios y con nombres representativos de las variables). Los nombres de las variables son los siguientes: Pais, CCAA, Periodo, Gasto_total, Gasto_medio_persona, Gasto_medio_diario_persona y Duracion_media.

```{r, include = FALSE}
nombres_columnas <- c("Pais", "CCAA", "Periodo", "Gasto_total", "Gasto_medio_persona", "Gasto_medio_diario_persona", "Duracion_media")
colnames(datos)<- nombres_columnas
colnames(datos)
```


## Transformación de clases

Todas las variables han sido importadas como tipo carácter. Transformamos las variables Gasto_total, Gasto_medio_persona, Gasto_medio_diario_persona y Duracion_media a numérico, donde previamente transformamos la cadena de carácteres a una que sea interpretable como número para poder aplicar la función as.numeric() correctamente (eliminando el punto de miles y sustituyendo la coma decimal por un punto decimal).

```{r, include = FALSE}
lapply(datos,class)
```

```{r, include=FALSE}
# Quitar punto de miles
datos[, 4:ncol(datos)] <- lapply(datos[, 4:ncol(datos)], function(x) gsub("\\.", "", x))
# Sustituir coma decimal por punto decimal
datos[, 4:ncol(datos)] <- lapply(datos[, 4:ncol(datos)], function(x) gsub(",", ".", x))
# Transformar a numerico
datos[, 4:ncol(datos)] <- lapply(datos[, 4:ncol(datos)], function(x) as.numeric(x))
# Comprobamos la clase
# lapply(datos,class)
```

Comprobamos si al realizar la transformación se han introducido datos NA y a continuación, transformamos a factor las variables Pais y CCAA.

```{r, include = FALSE}
any(is.na(datos))
```

```{r, include=FALSE}
# unique(datos$`País de residencia`)
# Transformacion a factor de paises de residencia
datos$Pais <- as.factor(datos$Pais)
```

Quitamos algunas filas que contienen datos que consisten en la suma total de los datos de la columna CCA (más adelante eliminaremos también los valores correspondientes a Total de la variable Pais). Sin embargo, recogeremos estos valores en datasets datos_totales y datos_total_por_residencia para hacer uso de ellos y obtener información relevante.
Cambiamos los nombres de los niveles del factor CCAA a los siguientes: "Andalucía", "Illes Balears","Canarias", "Cataluña","Comunitat Valenciana", "Comunidad de Madrid", "Otras CCAA".

```{r, include = FALSE}
# Guardamos los datos totales por si resultan útiles en el futuro
datos_totales <- subset(datos,datos$Pais == "Total" | datos$CCAA == "Total")
datos_total_por_residencia <- subset(datos, datos$CCAA == "Total")
```


```{r, include = FALSE}
# Quitar filas de total de columna comunidades autonomas
datos <- subset(datos,datos$CCAA != "Total")
```

```{r, include=FALSE}
# Transformacion a factor de nombres de comunidades
#unique(datos$`Total Nacional y CCAA`)
datos$CCAA<- as.factor(datos$CCAA)
# Cambiamos de nombre los niveles del factor
levels(datos$CCAA) <- c("Andalucía", "Illes Balears","Canarias", "Cataluña","Comunitat Valenciana", "Comunidad de Madrid", "Otras CCAA")


```


## Instance engineering

Vamos a trabajar con valores de las filas para obtener un dataset más apropiado al estudio que deseamos realizar. En primer lugar, queremos deshacernos del nivel "Total" en la variable Pais y transformarla en otro llamado "Otros" en que en el resto de variables contenga la información referente al resto de paises distintos de los cuáles poseemos datos concretos.

```{r, include=FALSE}
# Cambiar el nombre de las filas
paises <- levels(datos$Pais)
paises[paises=="Total"] <- "Otros"
levels(datos$Pais) <- paises

```

### Instance engineering de Gasto_total

Para la variable Gasto_total, las filas correspondientes a "Otros" de la variable Pais y las filas correspondientes a "Total" se relacionan de la siguiente manera con $pais\in$ {Alemania, Francia, Italia, Países Nórdicos, Reino Unido}:

$$ \text{Gasto total}_{\text{Total}} = \sum_{pais}{\text{Gasto total}_{pais}}$$
Luego el gasto total de "Otros" es el gasto de los valores "Total" de Pais menos el gasto de cada uno de los otros 5 paises disponibles por separado.
```{r, include=FALSE}

comunidades <- levels(datos$CCAA)
anos <- unique(datos$Periodo)
for (i in comunidades){
  for (j in anos){
  aux <- datos[datos$CCAA==i & datos$Periodo == j, "Gasto_total"]
datos[datos$CCAA==i & datos$Periodo == j & datos$Pais == "Otros", "Gasto_total"]<- aux[length(aux),] - sum(aux[1:length(aux)-1,])  
  }
}

```



### Instance engineering de Gasto_medio_persona, Gasto_medio_diario_persona y Duracion_media

Como en estas variables se trata de una media, no podemos emplear el método usado para Gasto_total. En su lugar consideramos una media ponderada. Si consideramos que el número de paises totales es 194 tenemos que para $pais \in$ 
{Alemania, Francia, Italia, Países Nórdicos, Reino Unido}:

$$
 \overline{Media\ Total} = \frac{5}{194}*\sum_{pais}{Valor\ medio}_{pais} + \frac{194-5}{194}*Valor \ Medio_{otros}
$$

De esta manera, concemos el valor de $\overline{Media\ Total}$ y de ${Valor\ medio}_{pais}$ y podemos calcular el valor de los valores medios para las filas "Otros" de la variable Pais, otorgándoles un mayor peso de manera proporcional al número de países considerados en esta categoría.

```{r, include=FALSE}
# Duracion media
for (i in comunidades){
  for (j in anos){
  aux <- datos[datos$CCAA==i & datos$Periodo == j, "Duracion_media"]
datos[datos$CCAA==i & datos$Periodo == j & datos$Pais == "Otros", "Duracion_media"]<- (aux[length(aux),]- (5/194)*sum(aux[1:length(aux)-1,]))*194/(194-5)
  }
}

```

```{r, include=FALSE}
# Gasto_medio_persona
for (i in comunidades){
  for (j in anos){
  aux <- datos[datos$CCAA==i & datos$Periodo == j, "Gasto_medio_persona"]
datos[datos$CCAA==i & datos$Periodo == j & datos$Pais == "Otros", "Gasto_medio_persona"]<- (aux[length(aux),]- (5/194)*sum(aux[1:length(aux)-1,]))*194/(194-5)
  }
}

```

```{r, include=FALSE}
# Gasto_medio_diario_persona
for (i in comunidades){
  for (j in anos){
  aux <- datos[datos$CCAA==i & datos$Periodo == j, "Gasto_medio_diario_persona"]
datos[datos$CCAA==i & datos$Periodo == j & datos$Pais == "Otros", "Gasto_medio_diario_persona"]<- (aux[length(aux),]- (5/194)*sum(aux[1:length(aux)-1,]))*194/(194-5)
  }
}

rm(i,j,anos,comunidades, paises, aux) # Borrar variables auxiliares
```


# Resumen de los datos

Una vez hemos concluido el pre-procesamiento de los datos, observamos el resultado en la Tabla \ref{tab:unnamed-chunk-27}.


```{r, eval=FALSE, include = FALSE}
knitr::kable(datos[1:10, ], format = "latex", 
             booktabs = TRUE, 
             caption = "This is a table caption. Tables should be placed in the 
             main text near to the first time they are~cited.", 
             align = 'ccc', centering = FALSE,
             table.envir = "table", position = "H")
```



\begin{table}[H]

\caption{\label{tab:unnamed-chunk-27} 10 primeras filas del conjunto de datos procesados}
             \begin{adjustwidth}{-\extralength}{0cm}
             \small
\begin{tabular}[t]{lccccccc}
\toprule
  & Pais & CCAA & Periodo & Gasto\_total & Gasto\_medio\_persona & Gasto\_medio\_diario\_persona & Duracion\_media\\
\midrule
1 & Alemania & Andalucía & 2016 & 1121.33 & 1132 & 102 & 11.14\\
2 & Alemania & Andalucía & 2017 & 1258.89 & 1123 & 105 & 10.70\\
3 & Alemania & Andalucía & 2018 & 1256.69 & 1165 & 114 & 10.18\\
4 & Alemania & Andalucía & 2019 & 1168.38 & 1048 & 117 & 8.96\\
5 & Alemania & Andalucía & 2020 & 255.96 & 1056 & 102 & 10.34\\
6 & Alemania & Andalucía & 2021 & 464.01 & 1040 & 100 & 10.39\\
7 & Alemania & Andalucía & 2022 & 1045.65 & 1211 & 113 & 10.69\\
8 & Alemania & Andalucía & 2023 & 1314.95 & 1267 & 130 & 9.71\\
17 & Alemania & Illes Balears & 2016 & 4436.99 & 961 & 129 & 7.44\\
18 & Alemania & Illes Balears & 2017 & 4890.66 & 1013 & 133 & 7.63\\
\bottomrule
\end{tabular}
	\end{adjustwidth}
\end{table} 

Vamos un resumen de los datos y de las variables disponibles. En la Tabla \ref{tab:codebook} se ha realizado un pequeño codebook con las variables del dataset.

\begin{table}[H]
 \caption{\label{tab:codebook} Descripción de las variables}
             \begin{adjustwidth}{-\extralength}{0cm}
             \small
             \centering
\begin{tabular}{@{}ccc@{}}
\toprule
Nombre variable & Unidad & Valores \\ \midrule
Pais & - & \begin{tabular}[c]{@{}c@{}}Alemania, Italia, Países Nórdicos, Francia, \\ Reino Unido, Otros\end{tabular} \\
CCAA & - & \begin{tabular}[c]{@{}c@{}}Andalucía, Illes Balears, Canarias, Cataluña, Comunitat Valenciana, \\ Comunidad de Madrid, Otras CCAA\end{tabular} \\
Periodo & Año & 2016-2023 \\
Gasto\_total & Millones de euros & Numérico \\
Gasto\_medio\_persona & Euros & Numérico \\
Gasto\_medio\_diario\_persona & Euros & Numérico \\
Duración\_media & Días & Numérico \\ \bottomrule
\end{tabular}


\end{adjustwidth}
\end{table}

Finalmente, antes de comenzar a visualizar datos y detectar patrones vemos un pequeño resumen de los datos:
```{r}
datos_resumen <- datos[4:7]
names(datos_resumen) <- c("Gasto total", "Gasto medio por persona", "Gasto medio diario/persona", "Duración media")

kable(summary(datos_resumen), format = "markdown")
```

# Primeras visualizaciones.


```{r fig.width=10, fig.height=5}
ggplot(datos, aes(x = factor(Periodo), y = Gasto_total, fill = CCAA)) +
  geom_col(position = "dodge") +  # "stack" para apiladas
  labs(
    title = "Gasto total por CCAA y año",
    x = "Año",
    y = "Gasto total"
  ) +
  theme_minimal()
```

```{r fig.width=5, fig.height=2.5}
# ggplot(datos, aes(x = CCAA, y = Gasto_total, fill = Pais)) +
#   geom_bar(stat = "identity", position = "dodge") +
#   labs(
#     title = "Gasto total por país y CCAA",
#     x = "CCAA",
#     y = "Gasto total"
#   ) +
#   theme_minimal()

# Sin otros para observar las tendencias entre los países principales

ggplot(datos %>% filter(Pais != "Otros"), 
       aes(x = CCAA, y = Gasto_total, fill = Pais)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Gasto total por país y CCAA",
    x = "CCAA",
    y = "Gasto total"
  ) +
  theme_minimal()
```

```{r fig.width=10, fig.height=5}
ggplot(datos, aes(x = Duracion_media, y = Gasto_medio_persona, size = Gasto_total, color = CCAA)) +
  geom_point(alpha = 0.7) +
  scale_size_continuous(range = c(1, 15)) +
  labs(
    title = "Bubble chart de gasto",
    x = "Duración media",
    y = "Gasto medio por persona",
    size = "Gasto total"
  ) +
  theme_minimal()
```
```{r fig.width=10, fig.height=5}

# 
# ggplot(datos, aes(x = Gasto_total, 
#                y = factor(Periodo), 
#                fill = Pais)) +
#   geom_density_ridges(alpha = 0.7, scale = 1.2) +
#   scale_fill_brewer(palette = "Set3") + 
#   labs(
#     title = "Distribución del Gasto Total por País a lo largo de los Años",
#     subtitle = "Ridgeline plot para una visualización elegante de densidades",
#     x = "Gasto Total",
#     y = "Año",
#     fill = "País"
#   ) +
#   theme_minimal(base_size = 12) +
#   theme(
#     legend.position = "bottom",
#     plot.title = element_text(face = "bold")
#   )

#Ahora sin otros, para observar mejor los países principales

ggplot(datos %>% filter(Pais != "Otros"), aes(x = Gasto_total, 
               y = factor(Periodo), 
               fill = Pais)) +
  geom_density_ridges(alpha = 0.7, scale = 1.2) +
  scale_fill_brewer(palette = "Set3") + 
  labs(
    title = "Distribución del Gasto Total por País a lo largo de los Años",
    #subtitle = "Ridgeline plot para una visualización elegante de densidades",
    x = "Gasto Total",
    y = "Año",
    fill = "País"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold")
  )
```

```{r, eval = FALSE}
# Visualización de los datos e interpretación de los posibles patrones

# Visualización previa para tener una idea de ciertas variables de los datos
ggplot(datos, aes(x = Periodo, y = Gasto_total, color = CCAA, group = 1)) +
  geom_point() +
  labs(title = "Evolución del gasto total de turistas por año", x  = "Años", y = "Gasto total en millones de euros")
```



```{r fig.width=10, fig.height=5, eval = FALSE}
# Para todas las Comunidades Autónomas por separado
ggplot(datos, aes(x = Pais, y = Duracion_media, fill = Pais)) + 
  geom_bar(stat = "identity") +
  facet_wrap(~ CCAA, scales = "free_y") +  
  labs(title = "Duración media del viaje por país en cada Comunidad Autónoma", 
       x = "País", 
       y = "Duración media del viaje") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

# Efecto del covid-19  

Probamos a analizar el efecto del COVID en el gasto de los turistas, así como estudiar los países que más reducieron su gasto debido a la pandemia. 
```{r gasto total covid,fig.width= 6, fig.height = 3, fig.cap='Gasto total de turistas en millones de euros por año'}
datos_summary <- datos %>%
  group_by(Periodo) %>%
  summarize(Gasto_total_anual = sum(Gasto_total, na.rm = TRUE))

datos_summary <- datos_summary %>%
  mutate(highlight = if_else(Periodo == 2020, "2020 (COVID)", "Otros años"))

  
ggplot(datos_summary, aes(x = factor(Periodo), y = Gasto_total_anual, fill = highlight)) +
  geom_col() +
  scale_fill_manual(values = c("2020 (COVID)" = "#e63946",
                               "Otros años"   = "#457b9d")) +
  labs(
    title = "Evolución del Gasto Total",
    #subtitle = "Se observa un descenso en 2020 (COVID) y una posterior recuperación",
    x = "Año",
    y = "Gasto Total"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  # Anotación adicional
  annotate("text",
           x = which(levels(factor(datos_summary$Periodo)) == "2020"), # posición x del año 2020
           y = datos_summary$Gasto_total_anual[datos_summary$Periodo == 2020] + 1000, 
           label = "Caída por COVID",
           color = "#e63946",
           fontface = "italic",
           size = 5,
           vjust = -0.5)
```

```{r}
covid <- datos[datos$Periodo == 2020, ]
no_covid <- datos[datos$Periodo != 2020, ]
media_sin_covid <- mean(no_covid$Gasto_total[])
media_covid <- mean(covid$Gasto_total)
```
La media del gasto total durante el COVID es de `r media_covid` millones de euros mientras que sin COVID es de `r media_sin_covid` millones de euros, una diferencia más que notable tal y como se observa en la gráfica \@ref(fig:gasto total covid)), con un descenso drástico en 2020 (COVID) y una posterior recuperación. En el gráfico\@ref(fig:gasto paises covid)) vemos que Reino Unido gastó más en COVID que el resto de países, Italia el que menos. 


```{r gasto paises covid, fig.width=5, fig.height = 2.5}
covid_sin_otros <- covid[covid$Pais != "Otros", ]
covid_sin_otros %>% ggplot(aes(x = Pais, y = Gasto_total, fill = Pais)) + geom_bar(stat = "identity") + labs(title = "Gasto total de los distintos países durante el COVID") 
```


Por otro lado, podemos observar que la Comunidad Autónoma a la que más se viajo durante el año del covid 2020 fueron las islas Canarias. Esto puede tener diversas explicaciones. Por un lado, los primeros meses del año, antes de las restricciones, el turismo en las islas Canarias es mayor debido al buen tiempo incluso en los meses de invierno. Por otro lado, el impacto del Covid en las islas puedo haber sido menor y haber impuesto menos restricciones. Otro posible motivo es la gran dependencia económica del turismo de las islas y una mayor disposición a atraer y recuperar el turismo perdido lo antes posible. 

```{r gasto comunidades covid, fig.width= 5, fig.height = 2.5}

covid_sin_otros %>% ggplot(aes(x = CCAA, y = Gasto_total, fill = CCAA)) + geom_bar(stat = "identity")  + labs(title = "Gasto total en las distintas comunidades autónomas durante el COVID")

```
# Otras gráficas

<!-- Para ver cómo cambia el gasto total a lo largo de los años y compararlo entre distintas Comunidades Autónomas: -->

```{r fig.width=10, fig.height=5, eval = FALSE}
ggplot(datos, aes(x = Periodo, y = Gasto_total, color = CCAA, group = CCAA)) +
  geom_line(linewidth = 1) +
  geom_point() +
  labs(
    title = "Evolución del gasto total por CCAA",
    x = "Año",
    y = "Gasto total"
  ) +
  theme_minimal()
```



<!-- Para explorar la relación entre el gasto medio por persona y la duración media del viaje, por ejemplo: -->

```{r fig.width=10, fig.height=5, eval = FALSE}
ggplot(datos, aes(x = Duracion_media, y = Gasto_medio_persona, color = CCAA)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Relación entre duración media y gasto medio por persona",
    x = "Duración media (días)",
    y = "Gasto medio por persona"
  ) +
  theme_minimal()
```

<!-- Para comparar la distribución de gasto medio por persona entre distintas CCAA: -->

```{r fig.width=10, fig.height=5, eval = FALSE}
ggplot(datos, aes(x = CCAA, y = Gasto_medio_persona, fill = CCAA)) +
  geom_boxplot(alpha = 0.7) +
  labs(
    title = "Distribución de gasto medio por persona por CCAA",
    x = "CCAA",
    y = "Gasto medio por persona"
  ) +
  theme_minimal() +
  theme(legend.position = "none")  # si deseas quitar la leyenda

```

<!-- Para observar cómo varían los viajes por país de origen y CCAA de destino, hay varias opciones. -->

<!-- Para ver el gato total por CCAA a lo largo del tiempo, separado por país: -->

```{r fig.width=10, fig.height=5, eval = FALSE}
ggplot(datos, aes(x = Periodo, y = Gasto_total, color = CCAA)) +
  geom_line(linewidth = 1) +
  facet_wrap(~ Pais) +
  labs(
    title = "Gasto total por CCAA a lo largo del tiempo, separado por país",
    x = "Año",
    y = "Gasto total"
  ) +
  theme_minimal()

```


################################################################

Filtraremos los datos totales por el Periodo y recogeremos solo la variable que nos sirve para representar la magnitud de valores en el mapa de visualización, en este caso el gasto medio por persona

```{r}
# Tomamos los distintos periodos que existen en nuestro conjunto de datos para diferenciar temporalmente
periodos <- unique(datos_total_por_residencia$Periodo)

#Separamos los gastos por países Nórdicos y el resto ya que se querrá hacer una subdivisión más para estos
datos_total_residencia <- datos_total_por_residencia %>% 
  select (Pais, Gasto_total, Gasto_medio_persona, Gasto_medio_diario_persona, Duracion_media, Periodo) %>%
  filter (Periodo %in% periodos & Pais != "Total")

datos_total_residencia_PN <- datos_total_residencia %>% 
  select (Pais, Gasto_total, Gasto_medio_persona, Gasto_medio_diario_persona, Duracion_media, Periodo) %>%
  filter(Pais == "Países Nórdicos")

# Introducimos 4 filas iguales sobre los países nórdicos para separar con el join estos y poder representarlos en el mapa

datos_total_residencia <- rbind(datos_total_residencia, datos_total_residencia_PN,
                                 datos_total_residencia_PN, datos_total_residencia_PN, datos_total_residencia_PN)

# El ano de referencia de los mapas determina el año en que se recogió la información de las coordenadas y la división de los países (como no hay ninguna división o cambio de coordenadas importante para los países y los períodos importantes no es muy relevante)
año_ref <- 2020

# Datos
countries <- gisco_get_countries(year = año_ref,
                        resolution = 20) %>%
  select(CNTR_ID, NAME_ENGL, geometry) %>%
           st_transform(3035)

# En los datos que podemos recoger de la librería que nos determina las coordenadas de los países necesitamos filtrar por los que vamos a estudiar en base a nuestro conjunto de datos.
paises_english <- c('United Kingdom', 'Denmark', 'Germany', 'France', 'Italy', 'Sweden', 'Norway', 'Iceland', 'Finland')
countries_filtered <- countries %>% filter(NAME_ENGL %in% paises_english)

# Incluir columna de identificación de los países para unir con las coordenadas de los mapas
CNTR_ID <- c('UK','DK', 'DE', 'FR', 'IT', 'SE', 'NO','IS', 'FI')
Country_Ids <- c()
for(pais in CNTR_ID)
{
  Country_aux <- rep(pais, times = length(periodos))
  Country_Ids <- c(Country_Ids, Country_aux)
}

datos_total_residencia <- cbind(datos_total_residencia, Country_Ids)


datos_total_residencia_viz <- datos_total_residencia %>% left_join(countries, by=join_by(Country_Ids == CNTR_ID))

#gastos_medio_viz <- gastos_medio_residencia %>% left_join(countries, by=join_by(CNTR_ID == CNTR_ID))
```



```{r, fig.pos='H'}
# Mapa base 
 geographic_map_gasto_medio <-  ggplot(datos_total_residencia_viz)  + 
   geom_sf(aes(geometry= geometry,      
          fill=Gasto_medio_persona), 
          linewidth=0.5) + facet_wrap(~Periodo) +
   theme(
    axis.text.x = element_blank(),  
    axis.text.y = element_blank(),
    axis.ticks = element_blank())  

  geographic_map_gasto_medio <- geographic_map_gasto_medio +
  xlim(c(2200000, 7150000)) +
  ylim(c(1380000, 5500000)) +
  geom_sf_interactive(
    fill = NA,
    aes(
      data_id = Country_Ids,
      geometry = geometry,
      tooltip = Gasto_medio_persona
    ),
    color = "black",
    linewidth = 0.1
  )
girafe(ggobj = geographic_map_gasto_medio)

# Marta: Te comenté esta parte porque me estaba dando problemas al hacer knit no se por qué

# Gráfico
# ggplot(datos_total_residencia_viz) +
#   # Primera capa con todos los países
#   geom_sf(aes(geometry= geometry), data = datos_total_residencia_viz, fill = "grey80", color = NA) +
#   # Establece límites
#   xlim(c(2200000, 7150000)) +
#   ylim(c(1380000, 5500000))

```


```{r}
geographic_map_gasto_medio_diario <-  ggplot(datos_total_residencia_viz)  + 
   geom_sf(aes(geometry= geometry,      
          fill=Gasto_medio_diario_persona), 
          linewidth=0.5) + facet_wrap(~Periodo) +
   theme(
    axis.text.x = element_blank(),  
    axis.text.y = element_blank(),
    axis.ticks = element_blank())  

  geographic_map_gasto_medio_diario <- geographic_map_gasto_medio_diario +
  xlim(c(2200000, 7150000)) +
  ylim(c(1380000, 5500000)) +
  geom_sf_interactive(
    fill = NA,
    aes(
      data_id = Country_Ids,
      geometry = geometry,
      tooltip = Gasto_medio_diario_persona
    ),
    color = "black",
    linewidth = 0.1
  )
girafe(ggobj = geographic_map_gasto_medio_diario)
```

```{r}
geographic_map_gasto_total <-  ggplot(datos_total_residencia_viz)  + 
   geom_sf(aes(geometry= geometry,      
          fill=Gasto_total), 
          linewidth=0.5) + facet_wrap(~Periodo) +
   theme(
    axis.text.x = element_blank(),  
    axis.text.y = element_blank(),
    axis.ticks = element_blank())  

  geographic_map_gasto_total <- geographic_map_gasto_total +
  xlim(c(2200000, 7150000)) +
  ylim(c(1380000, 5500000)) +
  geom_sf_interactive(
    fill = NA,
    aes(
      data_id = Country_Ids,
      geometry = geometry,
      tooltip = Gasto_total
    ),
    color = "black",
    linewidth = 0.1
  )
girafe(ggobj = geographic_map_gasto_total)
```

```{r}
geographic_map_duracion_media <-  ggplot(datos_total_residencia_viz)  + 
   geom_sf(aes(geometry= geometry,      
          fill=Duracion_media), 
          linewidth=0.5) + facet_wrap(~Periodo) +
   theme(
    axis.text.x = element_blank(),  
    axis.text.y = element_blank(),
    axis.ticks = element_blank())  

  geographic_map_duracion_media <- geographic_map_duracion_media +
  xlim(c(2200000, 7150000)) +
  ylim(c(1380000, 5500000)) +
  geom_sf_interactive(
    fill = NA,
    aes(
      data_id = Country_Ids,
      geometry = geometry,
      tooltip = Duracion_media
    ),
    color = "black",
    linewidth = 0.1
  )
girafe(ggobj = geographic_map_duracion_media)
```

```{r}
# Datos
año_ref <- 2021
spain_CCAAs <- gisco_get_nuts(year = año_ref,
                              country = "Spain",
                        resolution = 20) 

ggplot(spain_CCAAs) +
  geom_sf(aes(geometry = geometry))

spain_Comunities <- spain_CCAAs %>% filter(LEVL_CODE == 2)
spain_CCAAs %>% 
  ggplot(aes(geometry = geometry)) +
  geom_sf(
    data = spain_Comunities,
    aes(fill = NUTS_NAME),
    color = "black",
    linewidth = 0.5
  ) +
  geom_sf(
    fill = NA,
    color = "black",
    linewidth = 0.1
  )
```


# Búsqueda de relaciones entre variables cuantitativas

Realizamos una visualización previa para detectar relaciones entre variables cuantitativas. En el gráfico \ref{fig:correlaciones}, se observan 3 relaciones que podemos estudiar un poco más a fondo: el gasto medio por persona frente al gasto medio diario, el gasto medio por persona frente a la duración media y el gasto medio diario frente a la duración media.
```{r, message = FALSE, fig.cap="Gráficos de dispersión y correlaciones entre variables cuantitativas.\\label{fig:correlaciones}", fig.pos='H'}
ggpairs(datos[4:7])+theme(axis.text = element_blank()) # Quita los números de los ejes
# Gráficos de dispersión y correlaciones entre variables cuantitativas
``` 

##  Gasto medio por persona y duración media


```{r, fig.cap="Gráficos de dispersión y correlaciones entre gasto medio por persona y la duración media de los viajes .\\label{fig:gastomediovsduracionmedia}", fig.pos='H'}
# Cálculo de las correlaciones
correlaciones <- datos %>%
  group_by(Pais) %>%
  summarise(correlacion = cor(Gasto_medio_persona, Duracion_media))


ggplot(data = datos, aes(x=Gasto_medio_persona, y =Duracion_media, color = CCAA)) + geom_point() + facet_wrap(~ Pais, labeller = label_wrap_gen(width = 15)) +
  labs(title = "Gasto medio por persona y duración media\n por país de residencia",
       x = "Gasto medio por persona (euros)",
       y = "Duración media de los viajes (días)") + theme_minimal() +
  geom_text(
    data = correlaciones,
    aes(label = paste("Cor.:", round(correlacion, 2))),
    x = Inf, y = Inf, hjust = 1.5, vjust = 1.1, size = 3, color = "black"
  )+
  theme(axis.text.x = element_blank())   # Quita los números del eje X
```


Se observa una relación aproximadamente lineal para la mayoría de países, donde se distinguen claramente la tendencia de duración de los viajes en las distintas comunidades autónomas, casi siempre mayor en la Comunitat Valenciana (salvo en Italia, probablemente por cercanía), excepto en la categoría de otros países. Debido a que esta categoría engloba a el resto de países del mundo, es más díficil encontrar relaciones.

## Gasto medio por persona frente al gasto medio diario por persona


Esta parece a priori la relación más obvia entre variables.
```{r,  fig.cap="Gráficos de dispersión y correlaciones entre gasto medio por persona y gasto medio diario por persona .\\label{fig:gastomediovsgastomediodiario}", fig.pos='H', fig.height=4}

# Cálculo de las correlaciones
correlaciones <- datos %>%
  group_by(CCAA) %>%
  summarise(correlacion = cor(Gasto_medio_persona, Gasto_medio_diario_persona))

ggplot(data = datos, aes(x=Gasto_medio_persona, y =Gasto_medio_diario_persona, color = Pais)) + geom_point(size = 1) + facet_wrap(~ CCAA, labeller = label_wrap_gen(width = 15)) +
  labs(title = "Relación entre gasto medio por persona y gasto\nmedio diario por comunidad autónoma",
       x = "Gasto medio por persona (euros)",
       y = "Gasto medio diario por persona (días)") + theme_minimal() +
   geom_text(
    data = correlaciones,
    aes(label = paste("Cor.:", round(correlacion, 2))),
    x = Inf, y = Inf, hjust = 1.6, vjust = 1, size = 3, color = "black"
  ) +
   theme(axis.text.x = element_blank())   # Quita los números del eje X
```

En la Comunitat Valenciana es donde hay una peor correlación, esto puede estar relacionado con que es también el destino de mayor duración de los viajes, lo que puede provocar un menor gasto medio diario.


```{r, fig.cap="Gráfico de dispersión entre gasto medio por persona y gasto medio diario .\\label{fig:gastomediovsgastomediodiarioconduracion}", fig.pos='H'}

ggplot(data = datos, aes(x=Gasto_medio_persona, y =Gasto_medio_diario_persona, color = Duracion_media)) + geom_point(size = 2)  + scale_color_gradient(low = "lightgreen", high = "darkgreen") +  # Gradiente en tonos de verde
  labs(title = "Relación entre gasto medio por persona y gasto\nmedio diario por comunidad autónoma",
       x = "Gasto medio por persona (euros)",
       y = "Gasto medio diario por persona (días)",
       color = "Duración media (días)") + theme_minimal() 
```

En el gráfico \ref{fig:gastomediovsgastomediodiarioconduracion} se puede ver que generalmente a mayor gasto medio por persona también se produce un mayor gasto medio diario. Sin embargo, observamos que aparentemente un aumento de la duración de los viajes provoca una disminución del gasto medio diario. Vamos a visualizar esto más claramente a continuación.

## Gasto medio diario y duracion media 


```{r,fig.cap="Gráfico de dispersión entre gasto medio diario por persona y duración media de los viajes .\\label{fig:gastomediodiariovsduracionmedia}", fig.pos='H'}
# Cálculo de las correlaciones
correlaciones <- datos %>%
  group_by(Pais) %>%
  summarise(correlacion = cor(Gasto_medio_diario_persona, Duracion_media))


ggplot(data = datos, aes(x=Gasto_medio_diario_persona, y =Duracion_media, color = CCAA)) + geom_point(size = 1) + facet_wrap(~ Pais, labeller = label_wrap_gen(width = 15)) +
  labs(title = "Relación entre gasto medio por persona y duración\nmedia por país de residencia",
       x = "Gasto medio por persona (euros)",
       y = "Duración media de los viajes (días)") + theme_minimal() +
  geom_text(
    data = correlaciones,
    aes(label = paste("Cor.:", round(correlacion, 2))),
    x = Inf, y = Inf, hjust =1, vjust = 1, size = 3, color = "black"
  )
```

Ahora podemos observar en el Gráfico \ref{fig:gastomediodiariovsduracionmedia} de manera clara que a mayor duración de los viajes se produce un menor gasto medio por persona.




```{r}
geographic_map_gasto_medio_diario <-  ggplot(datos_total_residencia_viz)  + 
   geom_sf(aes(geometry= geometry,      
          fill=Gasto_medio_diario_persona), 
          linewidth=0.5) + facet_wrap(~Periodo) +
   theme(
    axis.text.x = element_blank(),  
    axis.text.y = element_blank(),
    axis.ticks = element_blank())  

  geographic_map_gasto_medio_diario <- geographic_map_gasto_medio_diario +
  xlim(c(2200000, 7150000)) +
  ylim(c(1380000, 5500000)) +
  geom_sf_interactive(
    fill = NA,
    aes(
      data_id = Country_Ids,
      geometry = geometry,
      tooltip = Gasto_medio_diario_persona
    ),
    color = "black",
    linewidth = 0.1
  )
girafe(ggobj = geographic_map_gasto_medio_diario)
```

```{r}
geographic_map_gasto_total <-  ggplot(datos_total_residencia_viz)  + 
   geom_sf(aes(geometry= geometry,      
          fill=Gasto_total), 
          linewidth=0.5) + facet_wrap(~Periodo) +
   theme(
    axis.text.x = element_blank(),  
    axis.text.y = element_blank(),
    axis.ticks = element_blank())  

  geographic_map_gasto_total <- geographic_map_gasto_total +
  xlim(c(2200000, 7150000)) +
  ylim(c(1380000, 5500000)) +
  geom_sf_interactive(
    fill = NA,
    aes(
      data_id = Country_Ids,
      geometry = geometry,
      tooltip = Gasto_total
    ),
    color = "black",
    linewidth = 0.1
  )
girafe(ggobj = geographic_map_gasto_total)
```

```{r}
geographic_map_duracion_media <-  ggplot(datos_total_residencia_viz)  + 
   geom_sf(aes(geometry= geometry,      
          fill=Duracion_media), 
          linewidth=0.5) + facet_wrap(~Periodo) +
   theme(
    axis.text.x = element_blank(),  
    axis.text.y = element_blank(),
    axis.ticks = element_blank())  

  geographic_map_duracion_media <- geographic_map_duracion_media +
  xlim(c(2200000, 7150000)) +
  ylim(c(1380000, 5500000)) +
  geom_sf_interactive(
    fill = NA,
    aes(
      data_id = Country_Ids,
      geometry = geometry,
      tooltip = Duracion_media
    ),
    color = "black",
    linewidth = 0.1
  )
girafe(ggobj = geographic_map_duracion_media)
```

```{r}
# Datos
año_ref <- 2021
spain_CCAAs <- gisco_get_nuts(year = año_ref,
                              country = "Spain",
                        resolution = 20) 

ggplot(spain_CCAAs) +
  geom_sf(aes(geometry = geometry))

spain_Comunities <- spain_CCAAs %>% filter(LEVL_CODE == 2)
spain_CCAAs %>% 
  ggplot(aes(geometry = geometry)) +
  geom_sf(
    data = spain_Comunities,
    aes(fill = NUTS_NAME),
    color = "black",
    linewidth = 0.5
  ) +
  geom_sf(
    fill = NA,
    color = "black",
    linewidth = 0.1
  )
```


